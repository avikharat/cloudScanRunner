name: Accessibility Scanner

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'JSON configuration for accessibility scan'
        required: true
        type: string
        default: '{"user_id":"auth0|scanner","organization_id":"org_github","project_id":"proj_github","scan_config":{"mode":"manual","urls":["https://example.com"],"viewport":"1920x1080","accessibility_standard":"wcag2aa","capture_screenshots":true,"timeout_ms":30000},"metadata":{"trigger_source":"github_action","environment":"ci"}}'

jobs:
  accessibility-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.13.1'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Parse config
        run: |
          echo '${{ github.event.inputs.config }}' | jq . > config.json
          echo "Config parsed successfully"

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.API_BASE_URL }}" ]; then
            echo "❌ ERROR: API_BASE_URL secret is not set"
            echo "Please add API_BASE_URL to your repository secrets:"
            echo "  1. Go to Settings → Secrets and variables → Actions"
            echo "  2. Click 'New repository secret'"
            echo "  3. Name: API_BASE_URL"
            echo "  4. Value: https://your-api-domain.com"
            exit 1
          else
            echo "✅ API_BASE_URL secret is configured"
            echo "API Base URL: ${{ secrets.API_BASE_URL }}"
          fi

      - name: Run accessibility scan
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
        run: |
          echo "Starting accessibility scan..."
          echo "Using API Base URL: $API_BASE_URL"
          node run-scan.js config.json

      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-scan-results
          path: |
            screenshots/
            *.json
          retention-days: 7
          if-no-files-found: warn